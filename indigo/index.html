<html>
    <head>
        <script src="./js/jquery.min.js"></script>
        <script src="./js/jquery.Templates.js"></script>
        <script src="./js/jquery.cookies.js"></script> 
        <script src="./js/jquery.form.js"></script>
        <script src="./js/jq_rbapi.js"></script>   

        
           
        <script language="javascript">
        var rb;
        $( document ).ready(function() { 
            rb = new jq_rbapi("http://restbox/",{
                onError : function(err) { alert(err); },
                onUnhandledError : function(err) { $('#div_err').html(err); },
                onLostAuth : function() 
                    {
                        $('#panel_auth').show();  
                        $('#panel_logout').hide();
                    },
                onAuth : function() 
                    {
                        rb.userinfo().then(function(res)
                        {
                            $('#ulogin').html(res.login);    
                        });
                        $('#panel_auth').hide();  
                        $('#panel_logout').show();
                    },
                onLogout : function() 
                    {
                        $('#panel_auth').show();  
                        $('#panel_logout').hide();
                    },
                ready: function()
                    {
                        load_tasks();
                    }
                });
            
            $( "#authForm" ).submit(function( event ) {         
            // Stop form from submitting normally
                    event.preventDefault();  
                    
                    var res = rb.auth(
                            $('[name=login]').val(),
                            $('[name=password]').val()
                    );                      
            });

            $('#form_task').submit(function( event ) {   
                event.preventDefault(); 
                rb.sendform($('#form_task').one()[0]).then(
                    function(r)
                    {

                    }
                );     
            });

            $( "#newtaskform" ).submit(function( event ) {         
            // Stop form from submitting normally
                    event.preventDefault();  
                    
                    var res = rb.send('tables/save/tasks',
                        {
                            'name' : $( "#newtaskform" ).find('[name="name"]').val(),
                            'descr' : $( "#newtaskform" ).find('[name=descr]').val()
                        }
                    ).then(function(r)
                    {
                        load_tasks();
                    });                     
            });

            $("#tasklist").click(function(e){
                load_tasks();
            });

            $("#btn_logout").click(function(e){
                rb.logout(); 
            });

            $("#btn_taskform").click(function(e){
                taskform();            
            });

         //   load_tasks();
        });        
       
        function load_tasks()
        {
            rb.get('tables/tasks').then(function(_data)
            {
                $('#tasks').html('');
                $('#TPL_tasks').tmpl(_data).appendTo('#tasks');
            });  
        }                

        function taskform()
        {
            rb.get($('#form_url').val()).then(function(fdata)
            {
                console.log(fdata);
            });
        }
        </script>
        <script id="TPL_tasks" type="text/x-jquery-tmpl">
            <table>
            {{each items}}
                <tr>
                    <td>${name}</td>
                    <td>${descr}</td>
                    <td>${author}</td>
                    <td><a href="javascript:rb.send('delete')">Delete</a></td>
                </tr>
            {{/each}}
            </table>  
        </script> 
        <title>Indigo JQ 1.0.0</title>
    </head>
<body>

<div id="panel_auth">
    <h3>AUTH</h3>
    <form method="post" action="http://restbox/?q=auth" id="authForm" >
        <input type="text" name="login" value="vasyan" />
        <input type="password" name="password" value="" />
        <input type="submit" value="ENTER"/>
    </form>
</div> 

<div id="panel_logout" style="display:none">
    Hello, <span id="ulogin"></span>
    <button id="btn_logout">Logout</button>
</div>



<div>
<h4>TASKS</h4><button id="tasklist">GET </button>
<table>
    <tbody id="tasks">
    </tbody>
</table>
</div>
<button id="btn_taskform">GET FORM </button><input type="text" id="form_url" value="forms/task/1/2" />

<h3>Add new task</h3>
<form method="post" action="http://restbox/?q=forms/task/submit" id="form_task">
    Name: <input type="text" name="name"  /><br />
    Description: <textarea name="descr" rows="5" cols="12" ></textarea>    
    <input type="submit" value="SAVE"/>
</form>

<div id="div_err"></div>

</body>
</html>